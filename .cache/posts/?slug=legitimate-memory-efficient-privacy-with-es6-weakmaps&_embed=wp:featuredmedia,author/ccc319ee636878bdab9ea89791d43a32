{"value":{"body":"[{\"id\":10255,\"date\":\"2015-03-19T08:06:10\",\"date_gmt\":\"2015-03-19T15:06:10\",\"guid\":{\"rendered\":\"https://www.sitepen.com/blog/?p=10255\"},\"modified\":\"2019-12-11T06:06:37\",\"modified_gmt\":\"2019-12-11T14:06:37\",\"slug\":\"legitimate-memory-efficient-privacy-with-es6-weakmaps\",\"status\":\"publish\",\"type\":\"post\",\"link\":\"https://wp.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/\",\"title\":{\"rendered\":\"Legitimate, memory-efficient privacy with ES6 WeakMaps\"},\"content\":{\"rendered\":\"<p>When writing object-oriented source code, you generally only want to expose a very specific API to whomever is using it. In many languages you would control this by marking methods and properties you do not want other developers to use as <code>private</code>. However, if you have been writing JavaScript for any amount of time, you know that there is no <code>private</code> keyword for object properties and methods. The best option we have prior to EcmaScript6 (ES6) to protect data is to hide it inside a closure. But this comes with problems of its own, notably that data must be shared across instances, deliberately removed in order to prevent memory leaks, or new privileged methods must be allocated each time the object is instantiated. Fortunately, ES6 brings us <a href=\\\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap\\\">WeakMaps</a>, which we can use to achieve legitimate privacy without the risk of accidentally blocking garbage collection.</p>\\n<p><!--more--></p>\\n<p>WeakMaps look similar to a plain object in that they are collections of key/value pairs, but have some important differences. First, they accept only objects (as opposed to strings) as keys. Second, they cannot be iterated. And most importantly, they do not interfere with <a href=\\\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Memory_Management#Mark-and-sweep_algorithm\\\">garbage collection</a> (hence the name <strong>Weak</strong>Map), so forgetting to remove objects from WeakMaps will not result in memory leaks.</p>\\n<p>While the MDN link above describes the <code>WeakMap</code> API in detail, we will still discuss its role in object data privacy. To start, we instantiate a <code>WeakMap</code> and store it in a local variable. Next, we create a new class that stores a reference to itself in the map (with <code>WeakMap#set</code>). Finally, as each instance adds a new object to the map, the other methods on the class’ prototype chain can access the private data with <code>WeakMap#get(this)</code>:</p>\\n<pre class=\\\"brush: jscript; title: ; notranslate\\\" title=\\\"\\\">\\r\\n(function () {\\r\\n\\tvar data = new WeakMap();\\r\\n\\r\\n\\tfunction Constructor() {\\r\\n\\t\\t// Add a new object for our private data store to the weak map\\r\\n\\t\\tdata.set(this, Object.create(null));\\r\\n\\t}\\r\\n\\r\\n\\tConstructor.prototype.privilegedMethod = function () {\\r\\n\\t\\t// do something with the object returned by `data.get(this)`\\r\\n\\t};\\r\\n})();</pre>\\n<h3>Don&#8217;t we already have a solution for real privacy?</h3>\\n<p>In his book <cite>JavaScript: The Good Parts</cite>, Douglas Crockford details an approach for fully encapsulating private data. In short, a factory method returns an object of privileged methods that have access to private data via a closure:</p>\\n<pre class=\\\"brush: jscript; title: ; notranslate\\\" title=\\\"\\\">var factory = function () {\\r\\n\\tvar privateData = {};\\r\\n\\r\\n\\treturn {\\r\\n\\t\\tprivilegedMethod: function () {\\r\\n\\t\\t\\t// do something with `privateData`\\r\\n\\t\\t}\\r\\n\\t};\\r\\n};</pre>\\n<p>So why would we need a different approach? Since the privileged methods in the above factory are created on the fly, the runtime environment has to allocate memory for them each time a new object is instantiated (even though the functions are identical). <code>WeakMap</code>s allow you to both reuse the same allocated methods and truly encapsulate private data.</p>\\n<p><em><strong>Note:</strong> The current <code>WeakMap</code> implementation uses a lot of memory (Google Chrome’s Heap Snapshot profiler shows the retained memory size of <code>new WeakMap()</code> as ten times that of <code>Object.create(null)</code>). However, once this is optimized so that the <code>WeakMap</code> keys are stored as values on a hidden storage object, memory usage should be very comparable to that of regular JavaScript objects. Even with this caveat, data-intensive applications will consume less memory with <code>WeakMap</code> storage than with the pre-ES6 method.</em></p>\\n<h3>Which problems are not solved?</h3>\\n<p>As nice as <code>WeakMap</code>s are, we still do not have a way for subclasses to inherit private data used by parent classes (in other words, we have <em>private</em> data but still not <em>protected</em> data), unless you are able to store all of your subclasses in the same closure as the original map. The same is true of private methods. If we need to refactor our public methods into a collection of private methods, the only way to truly hide them is to do so via a closure. Once again, this would make them unusable by child classes.</p>\\n<h3>When can WeakMaps be used?</h3>\\n<p>As you can see from <a href=\\\"http://kangax.github.io/compat-table/es6/#WeakMap\\\">kangax’s combatability table</a>, currently <code>WeakMap</code>s are not natively supported across many browsers. There are a handful of shims available, such as <a href=\\\"https://github.com/drses/weak-map\\\">weak-map</a> which was developed by the Google Caja team that comes close to being genuinely weak (i.e., it leaks very little memory), as well as a <a href=\\\"https://github.com/dojo/dojo2/issues/2\\\">work in progress Dojo 2 weak map implementation</a>. Since the existing polyfills inevitably will leak memory, if you decide to use them, it would be smart to deliberately call <code>WeakMap#delete</code> when you no longer need objects. That said, this might be one of the features to look forward to, rather than try to use now (unless, of course, you only have to support the environments that are already packaged with ES6 features).</p>\\n<h3>Conclusion</h3>\\n<p>While perhaps not as appealing or satisfying as actual <code>private</code> or <code>protected</code> keywords for methods and properties, with <code>WeakMap</code>s, JavaScript developers finally have a means of fully encapsulating private data without needing to repeatedly allocate memory for the same methods. If you are developing a small site, then you might not see a reason to be concerned with this additional memory consumption. But once you begin building real-time applications that consume significant amounts of data, then you might find <code>WeakMap</code> to be a very useful addition to your toolkit.</p>\\n<h2>Learning more</h2>\\n<p>If you need assistance with modern JavaScript development best practices, we are able to help via our <a href=\\\"https://www.sitepen.com/services/\\\">JavaScript support</a> and <a href=\\\"https://www.sitepen.com/development\\\">web app development</a> services. <a href=\\\"https://www.sitepen.com/contact/\\\">Contact us</a> for a free consultation to discuss how we can help you and your organization be more productive with JavaScript development.</p>\\n\",\"protected\":false},\"excerpt\":{\"rendered\":\"<p>When writing object-oriented source code, you generally only want to expose a very specific API to whomever is using it. In many languages you would control this by marking methods and properties you do not want other developers to use as private. However, if you have been writing JavaScript for any amount of time, you [&hellip;]</p>\\n\",\"protected\":false},\"author\":61,\"featured_media\":10361,\"comment_status\":\"closed\",\"ping_status\":\"closed\",\"sticky\":false,\"template\":\"\",\"format\":\"standard\",\"meta\":{\"spay_email\":\"\"},\"categories\":[3,6],\"tags\":[],\"series\":[],\"jetpack_featured_media_url\":\"\",\"yoast_head\":\"<!-- This site is optimized with the Yoast SEO plugin v14.5 - https://yoast.com/wordpress/plugins/seo/ -->\\n<title>Legitimate, memory-efficient privacy with ES6 WeakMaps | SitePen</title>\\n<meta name=\\\"robots\\\" content=\\\"index, follow\\\" />\\n<meta name=\\\"googlebot\\\" content=\\\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\\\" />\\n<meta name=\\\"bingbot\\\" content=\\\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\\\" />\\n<link rel=\\\"canonical\\\" href=\\\"https://www.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/\\\" />\\n<meta property=\\\"og:locale\\\" content=\\\"en_US\\\" />\\n<meta property=\\\"og:type\\\" content=\\\"article\\\" />\\n<meta property=\\\"og:title\\\" content=\\\"Legitimate, memory-efficient privacy with ES6 WeakMaps | SitePen\\\" />\\n<meta property=\\\"og:description\\\" content=\\\"When writing object-oriented source code, you generally only want to expose a very specific API to whomever is using it. In many languages you would control this by marking methods and properties you do not want other developers to use as private. However, if you have been writing JavaScript for any amount of time, you [&hellip;]\\\" />\\n<meta property=\\\"og:url\\\" content=\\\"https://www.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/\\\" />\\n<meta property=\\\"og:site_name\\\" content=\\\"SitePen\\\" />\\n<meta property=\\\"article:publisher\\\" content=\\\"https://www.facebook.com/SitePen\\\" />\\n<meta property=\\\"article:published_time\\\" content=\\\"2015-03-19T15:06:10+00:00\\\" />\\n<meta property=\\\"article:modified_time\\\" content=\\\"2019-12-11T14:06:37+00:00\\\" />\\n<meta property=\\\"og:image\\\" content=\\\"https://wp.sitepen.com/wp-content/uploads/2020/01/og_imageV1.jpg\\\" />\\n\\t<meta property=\\\"og:image:width\\\" content=\\\"1600\\\" />\\n\\t<meta property=\\\"og:image:height\\\" content=\\\"900\\\" />\\n<meta name=\\\"twitter:card\\\" content=\\\"summary_large_image\\\" />\\n<meta name=\\\"twitter:creator\\\" content=\\\"@SitePen\\\" />\\n<meta name=\\\"twitter:site\\\" content=\\\"@SitePen\\\" />\\n<script type=\\\"application/ld+json\\\" class=\\\"yoast-schema-graph\\\">{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@graph\\\":[{\\\"@type\\\":\\\"WebSite\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\",\\\"url\\\":\\\"https://wp.sitepen.com/\\\",\\\"name\\\":\\\"SitePen\\\",\\\"description\\\":\\\"Enterprise Web Apps Done Right\\\",\\\"potentialAction\\\":[{\\\"@type\\\":\\\"SearchAction\\\",\\\"target\\\":\\\"https://wp.sitepen.com/?s={search_term_string}\\\",\\\"query-input\\\":\\\"required name=search_term_string\\\"}],\\\"inLanguage\\\":\\\"en-US\\\"},{\\\"@type\\\":\\\"ImageObject\\\",\\\"@id\\\":\\\"https://www.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/#primaryimage\\\",\\\"inLanguage\\\":\\\"en-US\\\",\\\"url\\\":\\\"\\\"},{\\\"@type\\\":\\\"WebPage\\\",\\\"@id\\\":\\\"https://www.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/#webpage\\\",\\\"url\\\":\\\"https://www.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/\\\",\\\"name\\\":\\\"Legitimate, memory-efficient privacy with ES6 WeakMaps | SitePen\\\",\\\"isPartOf\\\":{\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\"},\\\"primaryImageOfPage\\\":{\\\"@id\\\":\\\"https://www.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/#primaryimage\\\"},\\\"datePublished\\\":\\\"2015-03-19T15:06:10+00:00\\\",\\\"dateModified\\\":\\\"2019-12-11T14:06:37+00:00\\\",\\\"author\\\":{\\\"@id\\\":\\\"https://wp.sitepen.com/#/schema/person/07946fa5d07c9341828fd0a9b1a8192d\\\"},\\\"inLanguage\\\":\\\"en-US\\\",\\\"potentialAction\\\":[{\\\"@type\\\":\\\"ReadAction\\\",\\\"target\\\":[\\\"https://www.sitepen.com/blog/legitimate-memory-efficient-privacy-with-es6-weakmaps/\\\"]}]},{\\\"@type\\\":[\\\"Person\\\"],\\\"@id\\\":\\\"https://wp.sitepen.com/#/schema/person/07946fa5d07c9341828fd0a9b1a8192d\\\",\\\"name\\\":\\\"Matthew Wistrand\\\",\\\"image\\\":{\\\"@type\\\":\\\"ImageObject\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#personlogo\\\",\\\"inLanguage\\\":\\\"en-US\\\",\\\"url\\\":\\\"https://secure.gravatar.com/avatar/0118ad1d4f1dbbc656345bd6ab31fdb1?s=96&d=mm&r=g\\\",\\\"caption\\\":\\\"Matthew Wistrand\\\"}}]}</script>\\n<!-- / Yoast SEO plugin. -->\",\"_links\":{\"self\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/posts/10255\"}],\"collection\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/posts\"}],\"about\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/types/post\"}],\"author\":[{\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/users/61\"}],\"replies\":[{\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/comments?post=10255\"}],\"version-history\":[{\"count\":1,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/posts/10255/revisions\"}],\"predecessor-version\":[{\"id\":19750,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/posts/10255/revisions/19750\"}],\"wp:featuredmedia\":[{\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/media/10361\"}],\"wp:attachment\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/media?parent=10255\"}],\"wp:term\":[{\"taxonomy\":\"category\",\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/categories?post=10255\"},{\"taxonomy\":\"post_tag\",\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/tags?post=10255\"},{\"taxonomy\":\"series\",\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/series?post=10255\"}],\"curies\":[{\"name\":\"wp\",\"href\":\"https://api.w.org/{rel}\",\"templated\":true}]},\"_embedded\":{\"author\":[{\"id\":61,\"name\":\"Matthew Wistrand\",\"url\":\"\",\"description\":\"\",\"link\":\"https://wp.sitepen.com/blog/author/mwistrand/\",\"slug\":\"mwistrand\",\"avatar_urls\":{\"24\":\"https://secure.gravatar.com/avatar/0118ad1d4f1dbbc656345bd6ab31fdb1?s=24&d=mm&r=g\",\"48\":\"https://secure.gravatar.com/avatar/0118ad1d4f1dbbc656345bd6ab31fdb1?s=48&d=mm&r=g\",\"96\":\"https://secure.gravatar.com/avatar/0118ad1d4f1dbbc656345bd6ab31fdb1?s=96&d=mm&r=g\"},\"yoast_head\":\"<!-- This site is optimized with the Yoast SEO plugin v14.5 - https://yoast.com/wordpress/plugins/seo/ -->\\n<title>Matthew Wistrand, Author at SitePen</title>\\n<meta name=\\\"robots\\\" content=\\\"noindex, follow\\\" />\\n<meta property=\\\"og:locale\\\" content=\\\"en_US\\\" />\\n<meta property=\\\"og:type\\\" content=\\\"profile\\\" />\\n<meta property=\\\"og:title\\\" content=\\\"Matthew Wistrand, Author at SitePen\\\" />\\n<meta property=\\\"og:url\\\" content=\\\"https://www.sitepen.com/blog/author/mwistrand/\\\" />\\n<meta property=\\\"og:site_name\\\" content=\\\"SitePen\\\" />\\n<meta property=\\\"og:image\\\" content=\\\"https://secure.gravatar.com/avatar/0118ad1d4f1dbbc656345bd6ab31fdb1?s=500&#038;d=mm&#038;r=g\\\" />\\n<meta name=\\\"twitter:card\\\" content=\\\"summary_large_image\\\" />\\n<meta name=\\\"twitter:site\\\" content=\\\"@SitePen\\\" />\\n<script type=\\\"application/ld+json\\\" class=\\\"yoast-schema-graph\\\">{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@graph\\\":[{\\\"@type\\\":\\\"WebSite\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\",\\\"url\\\":\\\"https://wp.sitepen.com/\\\",\\\"name\\\":\\\"SitePen\\\",\\\"description\\\":\\\"Enterprise Web Apps Done Right\\\",\\\"potentialAction\\\":[{\\\"@type\\\":\\\"SearchAction\\\",\\\"target\\\":\\\"https://wp.sitepen.com/?s={search_term_string}\\\",\\\"query-input\\\":\\\"required name=search_term_string\\\"}],\\\"inLanguage\\\":\\\"en-US\\\"},{\\\"@type\\\":\\\"ProfilePage\\\",\\\"@id\\\":\\\"https://www.sitepen.com/blog/author/mwistrand/#webpage\\\",\\\"url\\\":\\\"https://www.sitepen.com/blog/author/mwistrand/\\\",\\\"name\\\":\\\"Matthew Wistrand, Author at SitePen\\\",\\\"isPartOf\\\":{\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\"},\\\"inLanguage\\\":\\\"en-US\\\"},{\\\"@type\\\":[\\\"Person\\\"],\\\"@id\\\":\\\"https://wp.sitepen.com/#/schema/person/07946fa5d07c9341828fd0a9b1a8192d\\\",\\\"name\\\":\\\"Matthew Wistrand\\\",\\\"image\\\":{\\\"@type\\\":\\\"ImageObject\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#personlogo\\\",\\\"inLanguage\\\":\\\"en-US\\\",\\\"url\\\":\\\"https://secure.gravatar.com/avatar/0118ad1d4f1dbbc656345bd6ab31fdb1?s=96&d=mm&r=g\\\",\\\"caption\\\":\\\"Matthew Wistrand\\\"},\\\"mainEntityOfPage\\\":{\\\"@id\\\":\\\"https://www.sitepen.com/blog/author/mwistrand/#webpage\\\"}}]}</script>\\n<!-- / Yoast SEO plugin. -->\",\"_links\":{\"self\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/users/61\"}],\"collection\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/users\"}]}}],\"wp:featuredmedia\":[{\"code\":\"rest_post_invalid_id\",\"message\":\"Invalid post ID.\",\"data\":{\"status\":404}}]}}]","headers":[["access-control-allow-headers","Authorization, Content-Type"],["access-control-expose-headers","X-WP-Total, X-WP-TotalPages"],["allow","GET"],["cache-control","max-age=2592000"],["connection","close"],["content-type","application/json; charset=UTF-8"],["date","Sat, 01 Aug 2020 15:34:02 GMT"],["expires","Mon, 31 Aug 2020 15:34:02 GMT"],["link","<https://wp.sitepen.com/wp-json/>; rel=\"https://api.w.org/\""],["server","Apache"],["transfer-encoding","chunked"],["vary","Origin"],["x-content-type-options","nosniff"],["x-powered-by","PHP/7.3.16-1+0~20200320.56+debian9~1.gbp370a75"],["x-robots-tag","noindex"],["x-wp-total","1"],["x-wp-totalpages","1"]]},"type":"Object"}