{"value":{"body":"[{\"id\":13217,\"date\":\"2016-10-04T13:46:52\",\"date_gmt\":\"2016-10-04T20:46:52\",\"guid\":{\"rendered\":\"https://www.sitepen.com/blog/?p=13217\"},\"modified\":\"2016-10-04T13:46:52\",\"modified_gmt\":\"2016-10-04T20:46:52\",\"slug\":\"solving-complex-dgrid-edge-cases\",\"status\":\"publish\",\"type\":\"post\",\"link\":\"https://wp.sitepen.com/blog/solving-complex-dgrid-edge-cases/\",\"title\":{\"rendered\":\"Solving complex dgrid edge cases\"},\"content\":{\"rendered\":\"<p><img class=\\\"align center size-full\\\" src=\\\"https://wp.sitepen.com/wp-content/uploads/2016/10/solving-complex-dgrid-edge-cases-investigate.jpg\\\" width=\\\"100%\\\" /></p>\\n<p>We were recently asked by the team at <a href=\\\"http://www.equorum.com/\\\">eQuorum</a> to investigate an issue with <a href=\\\"http://dgrid.io/\\\">dgrid</a> performance when leveraging the <code>dgrid/Tree</code> mixin. The issue was challenging to solve, so we thought it would be useful to share our story in debugging and solving it.</p>\\n<p><!--more--></p>\\n<h2>Background</h2>\\n<p>dgrid is a powerful Dojo-based component for managing large data sets through a virtual rendering technique. Its primary <code>OnDemandList/OnDemandGrid</code> APIs use <a href=\\\"http://dstorejs.io/\\\">dstore</a> as the source of their data. To optimize performance, only a fraction of the data from the store is rendered at any one time. Rows of data are added as the user scrolls the grid, while some rows of data are pruned to reduce memory consumption.</p>\\n<p>The dgrid <code>dgrid/Tree</code> mixin creates a parent-child relationship between rows. The Tree mixin manages the parent-child relationship, but from the <code>OnDemandList</code> point of view, the grid is still a flat collection of rows.</p>\\n<h2>The issue</h2>\\n<p>When a dgrid was created with a large number of child rows and the parent row expanded to show the child rows, scrolling resulted in the browser slowing down, impacting end user performance and usability. This issue was initially reported nearly two years ago, and something we had been planning to address with dgrid 2. However, the issue became increasingly urgent.</p>\\n<p>When a parent row was expanded, the child rows were being incrementally added just like any other rows in an <code>OnDemandList</code>. But the initial row pruning code was not created with the Tree mixin in mind, and was not pruning child rows as the user scrolled those rows far away from the viewport. So with a large number of children, the grid size continued to increase. Even worse, a parent row with a large number of children would cause all row pruning to stop. So scrolling down past the expanded row caused the grid to continue to grow in size.</p>\\n<p>Reading the <a href=\\\"https://github.com/SitePen/dgrid/issues/877\\\">original ticket</a>, the description does not necessarily imply that child row pruning was the problem, because the issue describes expanding a row, and then the parent rows not being pruned.</p>\\n<p>So a basic solution to the reported problem would be to just fix the parent pruning problem. The pruning code could have been improved to fix the large expanded row problem. However, just fixing this problem would mean that all of the child rows would have still been loaded and retained (not-pruned) in the grid.</p>\\n<h2>Beyond parent row pruning</h2>\\n<p>Once the parent row pruning issue was fixed, it was time to solve the deeper challenges. dgrid inserts invisible rows in the grid that act as sentinels (preload nodes). Those sentinels help dgrid decide which rows need to be added and which rows may be pruned. There is one placed before the first row in the grid and one right after the last row in the grid. When using the <code>dgrid/Tree</code> mixin, a sentinel is inserted at the top and the bottom of each group of child rows. The code that prunes rows was not navigating those sets of sentinels efficiently which caused all pruning to stop.</p>\\n<p>Rather than just fix the parent row pruning problem, we also wanted to tackle pruning of child rows. In general, we try to make dgrid efficient in all ways which includes running only the code that is needed. If you don&#8217;t use the <code>dgrid/Tree</code> mixin, we don&#8217;t want tree related code to run. It can be difficult writing dgrid extensions in this manner, and the <code>dgrid/Tree</code> mixin is no exception.</p>\\n<p>The original <code>OnDemandList</code> was not written with multiple sets of sentinels in mind. The <code>dgrid/Tree</code> mixin did the best it could but stopped short of child row pruning because that code in <code>OnDemandList</code> could not be overwritten by the <code>dgrid/Tree</code> mixin without significant code duplication. The code that manages the sentinels in <code>OnDemandList</code> needed to be refactored to support multiple sets of sentinels.</p>\\n<p><code>OnDemandList</code> manages the sentinels in a way that the groups of sentinels may have a hierarchy and be nested or the sentinels may be siblings at the same level. The <code>dgrid/Tree</code> mixin manages the sentinels in a way that defines a tree. A future plugin could use sentinels in a different manner, so that needed to be considered for any solution.</p>\\n<p><img class=\\\"align center size-full\\\" src=\\\"https://wp.sitepen.com/wp-content/uploads/2016/10/solving-complex-dgrid-edge-cases-rows.jpg\\\" alt=\\\"solving-complex-dgrid-edge-cases-investigate\\\" width=\\\"100%\\\" /></p>\\n<h2>Challenges</h2>\\n<p>As we worked through the solution, we had many challenges to solve. Smooth, slow scrolling is the easiest scenario to handle, where all rows are loaded one at a time, sequentially and the rows are pruned in small increments.</p>\\n<p>Fast scrolling is where the real challenges occur. If the user scrolls quickly, dgrid recognizes that and rather than try to load every row up to the new scroll position, it makes a jump in the data set. For example, suppose a grid was constructed and initially loaded 50 rows of data. The user then drags the scrollbar down to row 500 of the dgrid. For a jump that large, <code>OnDemandList</code> will prune all of the currently rendered rows and ask the store for items starting at approximately row 450 to render data for slow scrolling just above the currently selected row. With the <code>dgrid/Tree</code> mixin and expanded rows, the code has to not only figure out which parent rows might be visible, but it also has to figure out which child rows might be visible. It needs to do this while requesting the smallest number of items from the store and rendering only the rows that are absolutely needed.</p>\\n<p>In the case of a smooth, consistent scrollbar, as the user scrolls an <code>OnDemandList</code>, the sentinels grow and shrink in height. This is done so the grid&#8217;s content stays a consistent height, which causes the scrollbar&#8217;s dimensions to remain constant. As <code>OnDemandList</code> adds and prune rows, the sentinels&#8217; heights need to change to maintain that overall grid content height. With the <code>dgrid/Tree</code> mixin being used and multiple rows expanded or even multiple depths of rows expanded (child of a child of a parent kind of thing), there are many sentinel height calculations needed to keep a consistent scrollbar.</p>\\n<h2>Solution</h2>\\n<p>The solution for this fix is primarily contained in two commits:</p>\\n<ul>\\n<li><a href=\\\"https://github.com/SitePen/dgrid/commit/3cd8120b4a59932cddb2dbf1f2b649585e5d2b67\\\">Update row pruning</a></li>\\n<li><a href=\\\"https://github.com/SitePen/dgrid/commit/2ae74378bff7ef0c46d82732a52e5f5cc55666ed\\\">Improve row height calculations</a></li>\\n</ul>\\n<h2>Thanks!</h2>\\n<p>Thanks also to <a href=\\\"http://www.equorum.com/\\\">eQuorum</a> for their generous sponsorship of these efforts and for their contribution to the open source community!</p>\\n<p>eQuorum focuses on solving complex document management problems for hundreds of organizations in the manufacturing, engineering, utilities and AECO (Architectural, Engineering, Construction and Owner) arenas where customers seek to better organize documents, save time and enhance collaboration.</p>\\n<hr />\\n<h2>Learning more</h2>\\n<div style=\\\"margin-left: 20px;\\\">\\n<p><a href=\\\"https://www.sitepen.com/services/\\\"><img class=\\\"alignleft\\\" style=\\\"margin-top: 0px;\\\" src=\\\"https://wp.sitepen.com/wp-content/uploads/2016/06/SupportLogoBlogs2.jpg\\\" alt=\\\"Support Logo\\\" width=\\\"28\\\" /></a></p>\\n<p style=\\\"margin-top: -5px;\\\">Get help from <a href=\\\"https://www.sitepen.com/services/\\\">SitePen Support</a>, our fast and efficient solutions to JavaScript development problems of any size.</p>\\n<p><a href=\\\"https://www.sitepen.com/services/\\\"><img class=\\\"alignleft\\\" src=\\\"https://wp.sitepen.com/wp-content/uploads/2016/06/workshopslogoblogs2.jpg\\\" alt=\\\"Workshops Logo\\\" width=\\\"30\\\" /></a></p>\\n<p style=\\\"margin-top: 37px;\\\">SitePen workshops are a fun, hands-on way to keep up with JavaScript development and testing best practices. <a href=\\\"https://www.sitepen.com/services/\\\">Register</a> for an online workshop, today!</p>\\n<p><a href=\\\"https://www.sitepen.com/contact/\\\"><img class=\\\"alignleft\\\" src=\\\"https://wp.sitepen.com/wp-content/uploads/2016/06/ConsultingLogoBlogs2.jpg\\\" alt=\\\"Let's Talk! Logo\\\" width=\\\"30\\\" /></a></p>\\n<p style=\\\"margin-top: 35px;\\\"><a href=\\\"https://www.sitepen.com/contact/\\\">Let&#8217;s talk</a> about how we can help your organization improve their approach to automated testing.</p>\\n<p><a href=\\\"https://www.sitepen.com/contact/\\\"><img class=\\\"alignleft\\\" src=\\\"https://wp.sitepen.com/wp-content/uploads/2016/06/ContactLogoBlogs2.jpg\\\" alt=\\\"Contact Us Logo\\\" width=\\\"30\\\" /></a></p>\\n<p style=\\\"margin-top: 35px;\\\">Have a question? We&#8217;re here to help! <a href=\\\"https://www.sitepen.com/contact/\\\">Get in touch</a> and let&#8217;s see how we can work together.</p>\\n</div>\\n<p style=\\\"padding-bottom: 5px;\\\">\\n\",\"protected\":false},\"excerpt\":{\"rendered\":\"<p>We were recently asked by the team at eQuorum to investigate an issue with dgrid performance when leveraging the dgrid/Tree mixin. The issue was challenging to solve, so we thought it would be useful to share our story in debugging and solving it.</p>\\n\",\"protected\":false},\"author\":50,\"featured_media\":13280,\"comment_status\":\"closed\",\"ping_status\":\"closed\",\"sticky\":false,\"template\":\"\",\"format\":\"standard\",\"meta\":{\"spay_email\":\"\"},\"categories\":[396,2,16,58],\"tags\":[],\"jetpack_featured_media_url\":\"\",\"yoast_head\":\"<!-- This site is optimized with the Yoast SEO plugin v14.3 - https://yoast.com/wordpress/plugins/seo/ -->\\n<title>Solving complex dgrid edge cases | SitePen</title>\\n<meta name=\\\"robots\\\" content=\\\"index, follow\\\" />\\n<meta name=\\\"googlebot\\\" content=\\\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\\\" />\\n<meta name=\\\"bingbot\\\" content=\\\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\\\" />\\n<link rel=\\\"canonical\\\" href=\\\"https://www.sitepen.com/blog/solving-complex-dgrid-edge-cases/\\\" />\\n<meta property=\\\"og:locale\\\" content=\\\"en_US\\\" />\\n<meta property=\\\"og:type\\\" content=\\\"article\\\" />\\n<meta property=\\\"og:title\\\" content=\\\"Solving complex dgrid edge cases | SitePen\\\" />\\n<meta property=\\\"og:description\\\" content=\\\"We were recently asked by the team at eQuorum to investigate an issue with dgrid performance when leveraging the dgrid/Tree mixin. The issue was challenging to solve, so we thought it would be useful to share our story in debugging and solving it.\\\" />\\n<meta property=\\\"og:url\\\" content=\\\"https://www.sitepen.com/blog/solving-complex-dgrid-edge-cases/\\\" />\\n<meta property=\\\"og:site_name\\\" content=\\\"SitePen\\\" />\\n<meta property=\\\"article:publisher\\\" content=\\\"https://www.facebook.com/SitePen\\\" />\\n<meta property=\\\"article:author\\\" content=\\\"ehager\\\" />\\n<meta property=\\\"article:published_time\\\" content=\\\"2016-10-04T20:46:52+00:00\\\" />\\n<meta property=\\\"og:image\\\" content=\\\"https://wp.sitepen.com/wp-content/uploads/2020/01/og_imageV1.jpg\\\" />\\n\\t<meta property=\\\"og:image:width\\\" content=\\\"1600\\\" />\\n\\t<meta property=\\\"og:image:height\\\" content=\\\"900\\\" />\\n<meta name=\\\"twitter:card\\\" content=\\\"summary_large_image\\\" />\\n<meta name=\\\"twitter:creator\\\" content=\\\"@SitePen\\\" />\\n<meta name=\\\"twitter:site\\\" content=\\\"@SitePen\\\" />\\n<script type=\\\"application/ld+json\\\" class=\\\"yoast-schema-graph\\\">{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@graph\\\":[{\\\"@type\\\":\\\"WebSite\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\",\\\"url\\\":\\\"https://wp.sitepen.com/\\\",\\\"name\\\":\\\"SitePen\\\",\\\"description\\\":\\\"Enterprise Web Apps Done Right\\\",\\\"potentialAction\\\":[{\\\"@type\\\":\\\"SearchAction\\\",\\\"target\\\":\\\"https://wp.sitepen.com/?s={search_term_string}\\\",\\\"query-input\\\":\\\"required name=search_term_string\\\"}],\\\"inLanguage\\\":\\\"en-US\\\"},{\\\"@type\\\":\\\"ImageObject\\\",\\\"@id\\\":\\\"https://www.sitepen.com/blog/solving-complex-dgrid-edge-cases/#primaryimage\\\",\\\"inLanguage\\\":\\\"en-US\\\",\\\"url\\\":\\\"\\\"},{\\\"@type\\\":\\\"WebPage\\\",\\\"@id\\\":\\\"https://www.sitepen.com/blog/solving-complex-dgrid-edge-cases/#webpage\\\",\\\"url\\\":\\\"https://www.sitepen.com/blog/solving-complex-dgrid-edge-cases/\\\",\\\"name\\\":\\\"Solving complex dgrid edge cases | SitePen\\\",\\\"isPartOf\\\":{\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\"},\\\"primaryImageOfPage\\\":{\\\"@id\\\":\\\"https://www.sitepen.com/blog/solving-complex-dgrid-edge-cases/#primaryimage\\\"},\\\"datePublished\\\":\\\"2016-10-04T20:46:52+00:00\\\",\\\"dateModified\\\":\\\"2016-10-04T20:46:52+00:00\\\",\\\"author\\\":{\\\"@id\\\":\\\"https://wp.sitepen.com/#/schema/person/74b2d4b0762cdc0fa9b68322e9d12ad3\\\"},\\\"inLanguage\\\":\\\"en-US\\\",\\\"potentialAction\\\":[{\\\"@type\\\":\\\"ReadAction\\\",\\\"target\\\":[\\\"https://www.sitepen.com/blog/solving-complex-dgrid-edge-cases/\\\"]}]},{\\\"@type\\\":[\\\"Person\\\"],\\\"@id\\\":\\\"https://wp.sitepen.com/#/schema/person/74b2d4b0762cdc0fa9b68322e9d12ad3\\\",\\\"name\\\":\\\"Ed Hager\\\",\\\"image\\\":{\\\"@type\\\":\\\"ImageObject\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#personlogo\\\",\\\"inLanguage\\\":\\\"en-US\\\",\\\"url\\\":\\\"https://secure.gravatar.com/avatar/916b047338dd5e5934c7d866d31fa639?s=96&d=mm&r=g\\\",\\\"caption\\\":\\\"Ed Hager\\\"},\\\"sameAs\\\":[\\\"ehager\\\"]}]}</script>\\n<!-- / Yoast SEO plugin. -->\",\"_links\":{\"self\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/posts/13217\"}],\"collection\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/posts\"}],\"about\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/types/post\"}],\"author\":[{\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/users/50\"}],\"replies\":[{\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/comments?post=13217\"}],\"version-history\":[{\"count\":0,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/posts/13217/revisions\"}],\"wp:featuredmedia\":[{\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/media/13280\"}],\"wp:attachment\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/media?parent=13217\"}],\"wp:term\":[{\"taxonomy\":\"category\",\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/categories?post=13217\"},{\"taxonomy\":\"post_tag\",\"embeddable\":true,\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/tags?post=13217\"}],\"curies\":[{\"name\":\"wp\",\"href\":\"https://api.w.org/{rel}\",\"templated\":true}]},\"_embedded\":{\"author\":[{\"id\":50,\"name\":\"Ed Hager\",\"url\":\"\",\"description\":\"\",\"link\":\"https://wp.sitepen.com/blog/author/ehager/\",\"slug\":\"ehager\",\"avatar_urls\":{\"24\":\"https://secure.gravatar.com/avatar/916b047338dd5e5934c7d866d31fa639?s=24&d=mm&r=g\",\"48\":\"https://secure.gravatar.com/avatar/916b047338dd5e5934c7d866d31fa639?s=48&d=mm&r=g\",\"96\":\"https://secure.gravatar.com/avatar/916b047338dd5e5934c7d866d31fa639?s=96&d=mm&r=g\"},\"yoast_head\":\"<!-- This site is optimized with the Yoast SEO plugin v14.3 - https://yoast.com/wordpress/plugins/seo/ -->\\n<title>Ed Hager, Author at SitePen</title>\\n<meta name=\\\"robots\\\" content=\\\"noindex, follow\\\" />\\n<meta property=\\\"og:locale\\\" content=\\\"en_US\\\" />\\n<meta property=\\\"og:type\\\" content=\\\"profile\\\" />\\n<meta property=\\\"og:title\\\" content=\\\"Ed Hager, Author at SitePen\\\" />\\n<meta property=\\\"og:url\\\" content=\\\"https://www.sitepen.com/blog/author/ehager/\\\" />\\n<meta property=\\\"og:site_name\\\" content=\\\"SitePen\\\" />\\n<meta property=\\\"og:image\\\" content=\\\"https://secure.gravatar.com/avatar/916b047338dd5e5934c7d866d31fa639?s=500&#038;d=mm&#038;r=g\\\" />\\n<meta name=\\\"twitter:card\\\" content=\\\"summary_large_image\\\" />\\n<meta name=\\\"twitter:site\\\" content=\\\"@SitePen\\\" />\\n<script type=\\\"application/ld+json\\\" class=\\\"yoast-schema-graph\\\">{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@graph\\\":[{\\\"@type\\\":\\\"WebSite\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\",\\\"url\\\":\\\"https://wp.sitepen.com/\\\",\\\"name\\\":\\\"SitePen\\\",\\\"description\\\":\\\"Enterprise Web Apps Done Right\\\",\\\"potentialAction\\\":[{\\\"@type\\\":\\\"SearchAction\\\",\\\"target\\\":\\\"https://wp.sitepen.com/?s={search_term_string}\\\",\\\"query-input\\\":\\\"required name=search_term_string\\\"}],\\\"inLanguage\\\":\\\"en-US\\\"},{\\\"@type\\\":\\\"ProfilePage\\\",\\\"@id\\\":\\\"https://www.sitepen.com/blog/author/ehager/#webpage\\\",\\\"url\\\":\\\"https://www.sitepen.com/blog/author/ehager/\\\",\\\"name\\\":\\\"Ed Hager, Author at SitePen\\\",\\\"isPartOf\\\":{\\\"@id\\\":\\\"https://wp.sitepen.com/#website\\\"},\\\"inLanguage\\\":\\\"en-US\\\"},{\\\"@type\\\":[\\\"Person\\\"],\\\"@id\\\":\\\"https://wp.sitepen.com/#/schema/person/74b2d4b0762cdc0fa9b68322e9d12ad3\\\",\\\"name\\\":\\\"Ed Hager\\\",\\\"image\\\":{\\\"@type\\\":\\\"ImageObject\\\",\\\"@id\\\":\\\"https://wp.sitepen.com/#personlogo\\\",\\\"inLanguage\\\":\\\"en-US\\\",\\\"url\\\":\\\"https://secure.gravatar.com/avatar/916b047338dd5e5934c7d866d31fa639?s=96&d=mm&r=g\\\",\\\"caption\\\":\\\"Ed Hager\\\"},\\\"sameAs\\\":[\\\"ehager\\\"],\\\"mainEntityOfPage\\\":{\\\"@id\\\":\\\"https://www.sitepen.com/blog/author/ehager/#webpage\\\"}}]}</script>\\n<!-- / Yoast SEO plugin. -->\",\"_links\":{\"self\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/users/50\"}],\"collection\":[{\"href\":\"https://wp.sitepen.com/wp-json/wp/v2/users\"}]}}],\"wp:featuredmedia\":[{\"code\":\"rest_post_invalid_id\",\"message\":\"Invalid post ID.\",\"data\":{\"status\":404}}]}}]","headers":[["access-control-allow-headers","Authorization, Content-Type"],["access-control-expose-headers","X-WP-Total, X-WP-TotalPages"],["allow","GET"],["cf-cache-status","DYNAMIC"],["cf-ray","5a77552429b0e634-LHR"],["cf-request-id","037e738a950000e63481141200000001"],["connection","close"],["content-encoding","gzip"],["content-type","application/json; charset=UTF-8"],["date","Mon, 22 Jun 2020 16:26:43 GMT"],["expect-ct","max-age=604800, report-uri=\"https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct\""],["link","<https://wp.sitepen.com/wp-json/>; rel=\"https://api.w.org/\""],["server","cloudflare"],["set-cookie","__cfduid=da1cfad6cc295a5ac59cf0056a6bc40841592843203; expires=Wed, 22-Jul-20 16:26:43 GMT; path=/; domain=.sitepen.com; HttpOnly; SameSite=Lax"],["transfer-encoding","chunked"],["vary","Origin"],["x-content-type-options","nosniff"],["x-robots-tag","noindex"],["x-wp-total","1"],["x-wp-totalpages","1"]]},"type":"Object"}